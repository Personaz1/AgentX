{% extends "shared/base_layout.html" %}

{% block title %}NeuroRAT - Агент{% endblock %}

{% block extra_styles %}
    .chat-container {
        display: flex;
        height: calc(100vh - 80px);
        margin-top: 10px;
    }
    .chat-sidebar {
        width: 320px;
        background: #181818;
        border-right: 1px solid #222;
        display: flex;
        flex-direction: column;
        padding: 18px 12px;
        font-size: 14px;
        color: #aaa;
        min-width: 220px;
        max-width: 400px;
    }
    .sidebar-section {
        margin-bottom: 18px;
    }
    .sidebar-title {
        color: #0f0;
        font-weight: bold;
        margin-bottom: 6px;
        font-size: 15px;
    }
    .sidebar-info {
        font-family: 'Consolas', monospace;
        font-size: 13px;
        color: #eee;
        margin-bottom: 8px;
    }
    .sidebar-btn {
        display: block;
        width: 100%;
        margin-bottom: 6px;
        background: #111;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 2px;
        padding: 6px 0;
        font-family: 'Consolas', monospace;
        cursor: pointer;
        text-align: left;
        transition: background 0.2s, color 0.2s;
    }
    .sidebar-btn:hover {
        background: #0f0;
        color: #000;
    }
    .sidebar-status {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
    }
    .sidebar-section .quick-commands {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .sidebar-section .auto-command {
        background: #232323;
        color: #0f0;
        border: 1px solid #333;
        border-radius: 2px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        font-family: 'Consolas', monospace;
    }
    .sidebar-section .auto-command:hover {
        background: #222;
        border-color: #0f0;
    }
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-radius: 4px;
        overflow: hidden;
        background-color: #111;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        position: relative;
    }
    .chat-header {
        background-color: #181818;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #222;
    }
    .chat-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
    }
    .status-icon {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .status-active {
        background-color: #0f0;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
    }
    .status-inactive {
        background-color: #f00;
    }
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #0a0a0a;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    .chat-message {
        margin-bottom: 10px;
        max-width: 90%;
    }
    .message-user {
        margin-left: auto;
        background: #1e1e1e;
        border-left: 3px solid #0f0;
        border-radius: 3px;
        padding: 8px 12px;
        color: #eee;
    }
    .message-agent {
        margin-right: auto;
        background: #0f0f0f;
        border-left: 3px solid #0f0;
        border-radius: 3px;
        padding: 8px 12px;
        color: #0f0;
    }
    .message-terminal {
        margin: 0 auto 10px 0;
        background: #181818;
        border-left: 3px solid #00bfff;
        border-radius: 3px;
        padding: 8px 12px;
        color: #00bfff;
        font-family: 'Consolas', monospace;
        white-space: pre-wrap;
    }
    .message-error {
        margin: 10px auto;
        background: rgba(255, 0, 0, 0.1);
        border-left: 3px solid #f00;
        border-radius: 3px;
        padding: 8px 12px;
        color: #f00;
        width: 90%;
    }
    .message-time {
        font-size: 10px;
        color: #555;
        text-align: right;
        margin-top: 3px;
    }
    .chat-input {
        padding: 10px;
        border-top: 1px solid #222;
        background-color: #181818;
    }
    .chat-form {
        display: flex;
    }
    .chat-textarea {
        flex: 1;
        border: 1px solid #333;
        border-radius: 2px;
        padding: 8px 10px;
        resize: none;
        background-color: #0f0f0f;
        color: #0f0;
        font-family: 'Consolas', 'Monaco', monospace;
        margin-right: 10px;
        min-height: 35px;
    }
    .chat-textarea:focus {
        outline: none;
        border-color: #0f0;
        box-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
    }
    .send-btn {
        cursor: pointer;
        background-color: #111;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 2px;
        padding: 0 15px;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    .send-btn:hover {
        background-color: #0f0;
        color: #000;
    }
    .terminal-section {
        background: #101010;
        border-top: 1px solid #222;
        padding: 0;
        min-height: 180px;
        max-height: 320px;
        overflow-y: auto;
        font-family: 'Consolas', monospace;
        color: #00bfff;
        font-size: 13px;
        white-space: pre-wrap;
        position: relative;
    }
    .terminal-header {
        background: #191919;
        color: #00bfff;
        font-weight: bold;
        padding: 6px 12px;
        border-bottom: 1px solid #222;
        font-size: 13px;
    }
    .terminal-input {
        width: 100%;
        border: none;
        background: #101010;
        color: #00bfff;
        font-family: 'Consolas', monospace;
        font-size: 13px;
        padding: 8px 10px;
        outline: none;
    }
    .terminal-input:focus {
        background: #181818;
    }
    .drag-drop {
        border: 2px dashed #0f0;
        background: #191919;
        color: #0f0;
        padding: 18px;
        text-align: center;
        margin: 12px 0;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }
    .drag-drop.dragover {
        background: #222;
        color: #fff;
    }
{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Агент</div>
            <div class="sidebar-info">ID: {{ agent_id }}</div>
            <div class="sidebar-info">OS: {{ agent_os }}</div>
            <div class="sidebar-info">IP: {{ agent_ip }}</div>
            <div class="sidebar-status">Статус: <span class="status-icon status-{{ agent_status }}"></span> {{ agent_status }}</div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Быстрые команды</div>
            <div class="quick-commands">
                <span class="auto-command" data-cmd="!collect_system_info">system_info</span>
                <span class="auto-command" data-cmd="!scan">scan</span>
                <span class="auto-command" data-cmd="!collect_browser_data">browser_data</span>
                <span class="auto-command" data-cmd="!take_screenshot">screenshot</span>
                <span class="auto-command" data-cmd="!run_module keylogger">keylogger</span>
                <span class="auto-command" data-cmd="!exec whoami">whoami</span>
                <span class="auto-command" data-cmd="!help">help</span>
            </div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Функции</div>
            <button class="sidebar-btn" onclick="showPromptInfo()">Показать системный промпт</button>
            <button class="sidebar-btn" onclick="showApiDocs()">API & Function Calling</button>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Файлы</div>
            <div class="drag-drop" id="dragDrop">Перетащите файл сюда для загрузки</div>
        </div>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <h2><span class="status-icon status-{{ agent_status }}"></span> NeuroRAT-Agent [{{ agent_id }}]</h2>
            <div>{{ agent_os }} | {{ agent_ip }}</div>
        </div>
        <div class="control-bar">
            <div class="control-option">
                <span>Автономный режим</span>
                <div class="toggle" id="autonomousToggle"></div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message message-agent">
                <div class="message-content">Система готова к эксплуатации. Ожидаю команды.</div>
                <div class="message-time">{{ current_time }}</div>
            </div>
        </div>
        <div class="chat-input">
            <form id="chatForm" class="chat-form">
                <textarea id="messageInput" class="chat-textarea" placeholder="Введите команду..." rows="1"></textarea>
                <button type="submit" class="send-btn">▶</button>
            </form>
        </div>
        <div class="terminal-section" id="terminalSection">
            <div class="terminal-header">Терминал агента (WebSocket)</div>
            <div id="terminalOutput"></div>
            <input type="text" class="terminal-input" id="terminalInput" placeholder="Введите команду для терминала..." autocomplete="off" />
        </div>
    </div>
</div>
<div id="promptModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#181818; color:#eee; max-width:700px; margin:40px auto; padding:32px 28px; border-radius:8px; box-shadow:0 4px 24px #000; position:relative;">
        <button onclick="closePromptModal()" style="position:absolute; top:12px; right:18px; background:none; border:none; color:#0f0; font-size:22px; cursor:pointer;">×</button>
        <div id="promptModalContent" style="white-space:pre-wrap; font-family:'Consolas',monospace; font-size:14px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script>
// --- Markdown render ---
function renderMarkdown(text) {
    return marked.parse(text || '');
}

// --- Chat logic ---
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const autonomousToggle = document.getElementById('autonomousToggle');
const autoCommands = document.querySelectorAll('.auto-command');
const terminalSection = document.getElementById('terminalSection');
const terminalOutput = document.getElementById('terminalOutput');
const terminalInput = document.getElementById('terminalInput');
const dragDrop = document.getElementById('dragDrop');

let autonomousMode = false;

messageInput.focus();

messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.requestSubmit();
    }
    if ((e.key === 'Enter') && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        chatForm.requestSubmit();
    }
});

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;
    addMessage('user', message);
    messageInput.value = '';
    messageInput.style.height = 'auto';
    messageInput.focus();
    addMessage('agent', '...', false, true);
    sendMessageToAgent(message, autonomousMode);
});

autoCommands.forEach(cmd => {
    cmd.addEventListener('click', function() {
        const command = this.getAttribute('data-cmd');
        messageInput.value = command;
        messageInput.focus();
    });
});

function addMessage(sender, content, error = false, isLoading = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = error ? 'chat-message message-error' : `chat-message message-${sender}`;
    if (isLoading) messageDiv.classList.add('loading');
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    if (sender === 'agent' || sender === 'user') {
        contentDiv.innerHTML = renderMarkdown(content);
    } else {
        contentDiv.textContent = content;
    }
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    const now = new Date();
    timeDiv.textContent = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    messageDiv.appendChild(contentDiv);
    if (!error) {
        messageDiv.appendChild(timeDiv);
    }
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
    return messageDiv;
}

function sendMessageToAgent(message, autonomous) {
    fetch(`/api/agent/{{ agent_id }}/chat`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: message,
            autonomous_mode: autonomous
        })
    })
    .then(response => response.json())
    .then(data => {
        const loadingMsg = chatMessages.querySelector('.chat-message.loading');
        if (loadingMsg) loadingMsg.remove();
        if (data.error) {
            addMessage(null, `Ошибка: ${data.error}`, true);
        } else {
            addMessage('agent', data.response);
        }
    })
    .catch(error => {
        const loadingMsg = chatMessages.querySelector('.chat-message.loading');
        if (loadingMsg) loadingMsg.remove();
        addMessage(null, `Ошибка обработки запроса: ${error.message}`, true);
    });
}

autonomousToggle.addEventListener('click', function() {
    this.classList.toggle('active');
    autonomousMode = this.classList.contains('active');
    const statusMsg = autonomousMode ? '[+] Автономный режим активирован' : '[-] Автономный режим деактивирован';
    addMessage('agent', statusMsg, false);
});

messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// --- Терминал WebSocket ---
let termSocket = null;
function connectTerminal() {
    if (termSocket) termSocket.close();
    termSocket = new WebSocket(`ws://${window.location.host}/api/agent/terminal/ws?agent_id={{ agent_id }}`);
    termSocket.onopen = () => {
        terminalOutput.innerHTML += '<div style="color:#0f0">[Терминал подключен]</div>';
    };
    termSocket.onmessage = (event) => {
        let data = event.data;
        try {
            const msg = JSON.parse(data);
            if (msg.type === 'output') {
                terminalOutput.innerHTML += `<div>${msg.data}</div>`;
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
        } catch (e) {
            terminalOutput.innerHTML += `<div>${data}</div>`;
        }
    };
    termSocket.onclose = () => {
        terminalOutput.innerHTML += '<div style="color:#f00">[Терминал отключен]</div>';
    };
}
connectTerminal();

terminalInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const cmd = terminalInput.value.trim();
        if (cmd && termSocket && termSocket.readyState === 1) {
            termSocket.send(JSON.stringify({command: cmd}));
            terminalOutput.innerHTML += `<div style="color:#888">$ ${cmd}</div>`;
            terminalInput.value = '';
        }
    }
});

// --- Drag & Drop upload ---
dragDrop.addEventListener('dragover', function(e) {
    e.preventDefault();
    dragDrop.classList.add('dragover');
});
dragDrop.addEventListener('dragleave', function(e) {
    dragDrop.classList.remove('dragover');
});
dragDrop.addEventListener('drop', function(e) {
    e.preventDefault();
    dragDrop.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
});
function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('agent_id', '{{ agent_id }}');
    fetch('/api/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(resp => resp.json())
    .then(data => {
        addMessage('agent', `Файл ${file.name} загружен (${file.size} байт)`);
    })
    .catch(err => {
        addMessage(null, `Ошибка загрузки файла: ${err.message}`, true);
    });
}

// --- Системный промпт и API docs ---
function showPromptInfo() {
    fetch('/static/Model_Prompt.md')
        .then(resp => resp.text())
        .then(text => {
            document.getElementById('promptModalContent').textContent = text;
            document.getElementById('promptModal').style.display = 'flex';
        });
}
function showApiDocs() {
    fetch('/static/Agent%20Plan.md')
        .then(resp => resp.text())
        .then(text => {
            document.getElementById('promptModalContent').textContent = text;
            document.getElementById('promptModal').style.display = 'flex';
        });
}
function closePromptModal() {
    document.getElementById('promptModal').style.display = 'none';
}
</script>
{% endblock %}
