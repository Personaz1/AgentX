{% extends "shared/base_layout.html" %}

{% block title %}NeuroRAT - Агент{% endblock %}

{% block extra_styles %}
    .chat-container {
        display: flex;
        height: calc(100vh - 80px);
        margin-top: 10px;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-radius: 4px;
        overflow: hidden;
        background-color: #111;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
    
    .chat-header {
        background-color: #181818;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #222;
    }
    
    .chat-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
    }
    
    .status-icon {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .status-active {
        background-color: #0f0;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
    }

    .status-inactive {
        background-color: #f00;
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #0a0a0a;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .chat-message {
        margin-bottom: 10px;
        max-width: 90%;
    }

    .message-user {
        margin-left: auto;
        background: #1e1e1e;
        border-left: 3px solid #0f0;
        border-radius: 3px;
        padding: 8px 12px;
        color: #eee;
    }

    .message-agent {
        margin-right: auto;
        background: #0f0f0f;
        border-left: 3px solid #0f0;
        border-radius: 3px;
        padding: 8px 12px;
        color: #0f0;
    }
    
    .message-error {
        margin: 10px auto;
        background: rgba(255, 0, 0, 0.1);
        border-left: 3px solid #f00;
        border-radius: 3px;
        padding: 8px 12px;
        color: #f00;
        width: 90%;
    }
    
    .message-time {
        font-size: 10px;
        color: #555;
        text-align: right;
        margin-top: 3px;
    }
    
    .chat-input {
        padding: 10px;
        border-top: 1px solid #222;
        background-color: #181818;
    }
    
    .chat-form {
        display: flex;
    }
    
    .chat-textarea {
        flex: 1;
        border: 1px solid #333;
        border-radius: 2px;
        padding: 8px 10px;
        resize: none;
        background-color: #0f0f0f;
        color: #0f0;
        font-family: 'Consolas', 'Monaco', monospace;
        margin-right: 10px;
        min-height: 35px;
    }
    
    .chat-textarea:focus {
        outline: none;
        border-color: #0f0;
        box-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
    }

    .send-btn {
        cursor: pointer;
        background-color: #111;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 2px;
        padding: 0 15px;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .send-btn:hover {
        background-color: #0f0;
        color: #000;
    }

    .control-bar {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background-color: #0a0a0a;
        border-bottom: 1px solid #222;
    }

    .control-option {
        display: flex;
        align-items: center;
        margin-right: 20px;
        color: #666;
        font-size: 12px;
    }

    .toggle {
        position: relative;
        display: inline-block;
        width: 36px;
        height: 20px;
        background-color: #333;
        border-radius: 10px;
        margin: 0 8px;
    }
    
    .toggle:after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: #666;
        top: 2px;
        left: 2px;
        transition: all 0.2s;
    }

    .toggle.active {
        background-color: #004400;
    }
    
    .toggle.active:after {
        left: 18px;
        background-color: #0f0;
    }

    .auto-command {
        display: inline-block;
        background-color: #181818;
        color: #0f0;
        border: 1px solid #333;
        border-radius: 2px;
        padding: 4px 8px;
        margin: 0 4px;
        cursor: pointer;
        font-size: 12px;
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .auto-command:hover {
        background-color: #222;
        border-color: #0f0;
    }

    .quick-commands {
        padding: 5px 10px;
    }
{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-main">
        <div class="chat-header">
            <h2><span class="status-icon status-{{ agent_status }}"></span> NeuroRAT-Agent [{{ agent_id }}]</h2>
            <div>{{ agent_os }} | {{ agent_ip }}</div>
        </div>
        
        <div class="control-bar">
            <div class="control-option">
                <span>Автономный режим</span>
                <div class="toggle" id="autonomousToggle"></div>
            </div>
            
            <div class="quick-commands">
                <span class="auto-command" data-cmd="!collect_system_info">system_info</span>
                <span class="auto-command" data-cmd="!scan">scan</span>
                <span class="auto-command" data-cmd="!collect_browser_data">browser_data</span>
                <span class="auto-command" data-cmd="!take_screenshot">screenshot</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Здесь будут сообщения чата -->
            <div class="chat-message message-agent">
                <div class="message-content">Система готова к эксплуатации. Ожидаю команды.</div>
                <div class="message-time">{{ current_time }}</div>
            </div>
        </div>
        
        <div class="chat-input">
            <form id="chatForm" class="chat-form">
                <textarea id="messageInput" class="chat-textarea" placeholder="Введите команду..." rows="1"></textarea>
                <button type="submit" class="send-btn">▶</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const chatForm = document.getElementById('chatForm');
    const autonomousToggle = document.getElementById('autonomousToggle');
    const autoCommands = document.querySelectorAll('.auto-command');
    
    let autonomousMode = false;  // По умолчанию автономный режим выключен
    
    // Автофокус на поле ввода при загрузке
    messageInput.focus();

    // Отправка по Enter (без Shift)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.requestSubmit();
        }
        // Альтернативно: Ctrl+Enter/Command+Enter — всегда отправлять
        if ((e.key === 'Enter') && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            chatForm.requestSubmit();
        }
    });

    // Обработчик формы отправки сообщения
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;
        // Добавляем сообщение пользователя в чат
        addMessage('user', message);
        // Очищаем поле ввода и возвращаем фокус
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.focus();
        // Добавляем placeholder "Загрузка..." для UX
        addMessage('agent', '...', false, true);
        // Отправляем сообщение на сервер
        sendMessageToAgent(message, autonomousMode);
    });
    
    // Обработчики быстрых команд
    autoCommands.forEach(cmd => {
        cmd.addEventListener('click', function() {
            const command = this.getAttribute('data-cmd');
            messageInput.value = command;
            messageInput.focus();
        });
    });
    
    // Функция для добавления сообщения в чат
    function addMessage(sender, content, error = false, isLoading = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = error ? 'chat-message message-error' : `chat-message message-${sender}`;
        if (isLoading) messageDiv.classList.add('loading');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        const now = new Date();
        timeDiv.textContent = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        messageDiv.appendChild(contentDiv);
        if (!error) {
            messageDiv.appendChild(timeDiv);
        }
        chatMessages.appendChild(messageDiv);
        // Плавный скролл вниз
        chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        return messageDiv;
    }
    
    // Функция для отправки сообщения агенту
    function sendMessageToAgent(message, autonomous) {
        fetch(`/api/agent/{{ agent_id }}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                autonomous_mode: autonomous
            })
        })
        .then(response => response.json())
        .then(data => {
            // Удаляем placeholder "..." (последний loading)
            const loadingMsg = chatMessages.querySelector('.chat-message.loading');
            if (loadingMsg) loadingMsg.remove();
            if (data.error) {
                addMessage(null, `Ошибка: ${data.error}`, true);
            } else {
                // Добавляем ответ агента в чат
                addMessage('agent', data.response);
            }
        })
        .catch(error => {
            const loadingMsg = chatMessages.querySelector('.chat-message.loading');
            if (loadingMsg) loadingMsg.remove();
            addMessage(null, `Ошибка обработки запроса: ${error.message}`, true);
        });
    }
    
    // Переключатель автономного режима
    autonomousToggle.addEventListener('click', function() {
        this.classList.toggle('active');
        autonomousMode = this.classList.contains('active');
        // Добавляем информационное сообщение в чат
        const statusMsg = autonomousMode ? 
            '[+] Автономный режим активирован' : 
            '[-] Автономный режим деактивирован';
        addMessage('agent', statusMsg, false);
    });
    
    // Авто-ресайз поля ввода
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});
</script>
{% endblock %}
